name: Deploy FE App Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - master2
      - master3

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, staging, production]
        include:
          - env: dev
            branch: master
            storageAccountName: "devstorageaccount"
            frontdoorName: "dev-frontdoor"
            frontdoorRG: "dev-rg"
            endpointName: "dev-endpoint"
            domainName: "dev.domain.com"

          - env: staging
            branch: master2
            storageAccountName: "stagingstorageaccount"
            frontdoorName: "staging-frontdoor"
            frontdoorRG: "staging-rg"
            endpointName: "staging-endpoint"
            domainName: "staging.domain.com"

          - env: production
            branch: master3
            storageAccountName: "prodstorageaccount"
            frontdoorName: "prod-frontdoor"
            frontdoorRG: "prod-rg"
            endpointName: "prod-endpoint"
            domainName: "prod.domain.com"

    steps:
      - name: Check branch matches environment
        if: github.ref_name == matrix.branch
        run: |
          echo "Running for environment: ${MATRIX_ENV} on branch: ${GITHUB_REF_NAME}"
        env:
          MATRIX_ENV: ${{ matrix.env }}
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Build and Upload (Only on matching branch)
        if: github.ref_name == matrix.branch
        run: |
          echo "Building and uploading for environment: ${MATRIX_ENV}"
          echo "Storage Account: ${{ matrix.storageAccountName }}"
          echo "Domain Name: ${{ matrix.domainName }}"
        env:
          MATRIX_ENV: ${{ matrix.env }}

      - name: Cleanup Old Files (Only on matching branch)
        if: github.ref_name == matrix.branch
        run: |
          echo "Cleaning up for environment: ${MATRIX_ENV}"
          echo "Frontdoor Name: ${{ matrix.frontdoorName }}"
          echo "Endpoint Name: ${{ matrix.endpointName }}"
        env:
          MATRIX_ENV: ${{ matrix.env }}

      - name: Purge Front Door Cache (Only on matching branch)
        if: github.ref_name == matrix.branch
        run: |
          echo "Purging Front Door for environment: ${MATRIX_ENV}"
          echo "Frontdoor RG: ${{ matrix.frontdoorRG }}"
          echo "Domain Name: ${{ matrix.domainName }}"
        env:
          MATRIX_ENV: ${{ matrix.env }}
