name: Deploy FE App Pipeline

on:
  workflow_dispatch:   # Manual trigger
    inputs:
      branch:
        description: "Select branch to deploy (master, master2, master3)"
        required: true
        default: "master"
  push:                # Auto trigger on push
    branches:
      - master
      - master2
      - master3

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, staging, production]
        include:
          - env: dev
            branch: master
            storageAccountName: "devstorageaccount"
            frontdoorName: "dev-frontdoor"
            frontdoorRG: "dev-rg"
            endpointName: "dev-endpoint"
            domainName: "dev.domain.com"

          - env: staging
            branch: master2
            storageAccountName: "stagingstorageaccount"
            frontdoorName: "staging-frontdoor"
            frontdoorRG: "staging-rg"
            endpointName: "staging-endpoint"
            domainName: "staging.domain.com"

          - env: production
            branch: master3
            storageAccountName: "prodstorageaccount"
            frontdoorName: "prod-frontdoor"
            frontdoorRG: "prod-rg"
            endpointName: "prod-endpoint"
            domainName: "prod.domain.com"

    # Core Logic: If it's manual, use workflow_dispatch.input.branch
    # Otherwise (push), use github.ref_name
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.branch == matrix.branch) ||
      (github.event_name == 'push' && github.ref_name == matrix.branch)

    steps:
      - name: Print Deployment Info
        run: |
          echo "Running for Environment: ${{ matrix.env }}"
          echo "On Branch: ${{ matrix.branch }}"

      - name: Build & Upload
        uses: anujrajkumar/template/.github/workflows/blank.yml@main
        with:
          storageAccountName: ${{ matrix.storageAccountName }}
          app_name: ${{ matrix.env }}

      - name: Cleanup Static Files
        uses: anujrajkumar/template/.github/workflows/new.yaml@main
        with:
          storageAccountName: ${{ matrix.storageAccountName }}
