name: Callback Workflow with Matrix per Job

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (master, master2, master3)'
        required: true
        default: 'master'
  push:
    branches:
      - master
      - master2
      - master3

jobs:
  build-and-upload:
    strategy:
      matrix:
        include:
          - env: dev
            branch: master
            storageAccountName: "devstorageaccount"
            frontdoorName: "dev-frontdoor"
            frontdoorRG: "dev-rg"
            endpointName: "dev-endpoint"
            domainName: "dev.domain.com"
          - env: staging
            branch: master2
            storageAccountName: "stagingstorageaccount"
            frontdoorName: "staging-frontdoor"
            frontdoorRG: "staging-rg"
            endpointName: "staging-endpoint"
            domainName: "staging.domain.com"
          - env: production
            branch: master3
            storageAccountName: "prodstorageaccount"
            frontdoorName: "prod-frontdoor"
            frontdoorRG: "prod-rg"
            endpointName: "prod-endpoint"
            domainName: "prod.domain.com"

    steps:
      - name: Conditional Build & Upload
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.branch == matrix.branch) ||
          (github.event_name == 'push' && github.ref_name == matrix.branch)
        uses: anujrajkumar/template/.github/workflows/new.yaml@main

  cleanup:
    needs: build-and-upload
    strategy:
      matrix:
        include:
          - env: dev
            branch: master
            storageAccountName: "devstorageaccount"
            frontdoorName: "dev-frontdoor"
            frontdoorRG: "dev-rg"
            endpointName: "dev-endpoint"
            domainName: "dev.domain.com"
          - env: staging
            branch: master2
            storageAccountName: "stagingstorageaccount"
            frontdoorName: "staging-frontdoor"
            frontdoorRG: "staging-rg"
            endpointName: "staging-endpoint"
            domainName: "staging.domain.com"
          - env: production
            branch: master3
            storageAccountName: "prodstorageaccount"
            frontdoorName: "prod-frontdoor"
            frontdoorRG: "prod-rg"
            endpointName: "prod-endpoint"
            domainName: "prod.domain.com"

    steps:
      - name: Conditional Build & Upload
        if: |
          (github.event_name == 'workflow_dispatch' && github.event.inputs.branch == matrix.branch) ||
          (github.event_name == 'push' && github.ref_name == matrix.branch)
        uses: anujrajkumar/template/.github/workflows/blank.yml@main
