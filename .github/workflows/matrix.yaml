name: Deploy FE App Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - master2
      - master3

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, staging, production]
        include:
          - env: dev
            branch: master
            storageAccountName: "devstorageaccount"

          - env: staging
            branch: master2
            storageAccountName: "stagingstorageaccount"

          - env: production
            branch: master3
            storageAccountName: "prodstorageaccount"

    if: ${{ github.ref_name == matrix.branch }} # Skip job if branch doesn't match
    steps:
      - name: Build and Upload for ${{ matrix.env }}
        run: |
          echo "Building for ${{ matrix.env }} on branch ${{ github.ref_name }}"
          echo "Using Storage Account: ${{ matrix.storageAccountName }}"

  cleanup:
    runs-on: ubuntu-latest
    needs: build-and-upload
    strategy:
      matrix:
        env: [dev, staging, production]
        include:
          - env: dev
            branch: master
            frontdoorName: "dev-frontdoor"

          - env: staging
            branch: master2
            frontdoorName: "staging-frontdoor"

          - env: production
            branch: master3
            frontdoorName: "prod-frontdoor"

    if: ${{ github.ref_name == matrix.branch }} # Skip if not matching
    steps:
      - name: Cleanup for ${{ matrix.env }}
        run: |
          echo "Cleaning for ${{ matrix.env }} on branch ${{ github.ref_name }}"
          echo "Frontdoor Name: ${{ matrix.frontdoorName }}"

  purge-frontdoor:
    runs-on: ubuntu-latest
    needs: cleanup
    strategy:
      matrix:
        env: [dev, staging, production]
        include:
          - env: dev
            branch: master
            domainName: "dev.domain.com"

          - env: staging
            branch: master2
            domainName: "staging.domain.com"

          - env: production
            branch: master3
            domainName: "prod.domain.com"

    if: ${{ github.ref_name == matrix.branch }} # Skip if not matching
    steps:
      - name: Purge Frontdoor Cache for ${{ matrix.env }}
        run: |
          echo "Purging Frontdoor for ${{ matrix.env }} on branch ${{ github.ref_name }}"
          echo "Domain Name: ${{ matrix.domainName }}"
